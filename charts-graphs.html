<!DOCTYPE html>
<html>
<head>
    <title>Smart Invest - Charts & Graphs (Percent Change)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #181818;
            color: #e0e0e0;
        }

        #chartsGraphs {
            padding: 20px;
            text-align: center;
        }

        #graphContainer {
            width: 90%;
            max-width: 1000px; 
            margin: 20px auto;
        }

        #performanceGraph {
            width: 100%;
            height: 500px;
        }

        @media (max-width: 600px) {
            #performanceGraph {
                height: 300px;
            }
        }

        #graphControls {
            margin: 20px 0;
            text-align: center;
        }

        #stockGrid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .stock-button, .portfolio-option {
            padding: 10px 15px;
            font-size: 1em;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #202020;
            color: #e0e0e0;
            cursor: pointer;
        }

        .stock-button.selected,
        .portfolio-option.selected {
            background-color: #64ffda;
            color: #181818;
        }

        .portfolio {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin: 15px auto;
            padding: 10px;
            max-width: 400px;
            text-align: left;
            position: relative;
        }

        .portfolio.editing {
            outline: 1px dashed #64ffda;
        }

        .portfolio h3 {
            margin-top: 0;
        }

        .edit-icon, .delete-icon, .save-icon {
            margin: 5px;
            padding: 5px 10px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .stock-weight-list {
            list-style-type: none;
            padding-left: 0;
        }

        .stock-weight-list li {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .weight-label {
            margin-right: 10px;
        }

        .weight-input-inline,
        .weight-input {
            width: 60px;
            margin-left: 5px;
            margin-right: 5px;
            text-align: center;
            background-color: #303030;
            color: #e0e0e0;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        .validation-message {
            color: red;
            display: none;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <section id="chartsGraphs">
        <h1>Create and View Your Portfolio</h1>
        <div id="stockSelection">
            <p>Select up to 10 stocks from the SP500:</p>
            <div id="stockGrid">
                <!-- Stock options dynamically added -->
            </div>
        </div>
        <div id="portfolioWeights">
            <h3>Adjust Portfolio Weights</h3>
            <!-- Dynamic weight inputs will be added here -->
        </div>
        <button id="createPortfolio">Create Portfolio</button>
        <p id="weightValidationMessage" class="validation-message">Weights must add up to 100%.</p>

        <div id="savedPortfolios">
            <h2>Saved Portfolios</h2>
            <!-- Portfolios appended here -->
        </div>

        <div id="graphContainer">
            <canvas id="performanceGraph"></canvas>
        </div>

        <div id="graphControls">
            <label for="timePeriod">Select Time Period:</label>
            <select id="timePeriod">
                <option value="1m">1 Month</option>
                <option value="3m">3 Months</option>
                <option value="6m">6 Months</option>
                <option value="1y">1 Year</option>
            </select>
            <div id="portfolioOptions">
                <h3>Select Portfolios to Compare:</h3>
                <!-- Portfolio toggle buttons will be added here -->
            </div>
        </div>
    </section>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const stockGrid = document.getElementById("stockGrid");
        const createPortfolioButton = document.getElementById("createPortfolio");
        const savedPortfoliosDiv = document.getElementById("savedPortfolios");
        const portfolioWeightsDiv = document.getElementById("portfolioWeights");
        const portfolioOptionsDiv = document.getElementById("portfolioOptions");
        const weightValidationMessage = document.getElementById("weightValidationMessage");
        const ctx = document.getElementById("performanceGraph").getContext("2d");
        const timePeriodSelector = document.getElementById("timePeriod");

        const sp500Stocks = ["AAPL", "MSFT", "GOOGL", "AMZN", "TSLA", "META", "NVDA", "INTC", "AMD", "IBM"];
        // A set of selected tickers for the "currently building" portfolio
        const selectedStocks = new Set();
        // A dictionary for storing stock weights (ticker => weight)
        const stockWeights = {};
        // The list of all saved portfolios
        let activePortfolios = [];
        // Portfolios chosen to display on the chart
        let displayedPortfolios = [];

        // Initialize the Chart.js line chart
        let performanceGraph = new Chart(ctx, {
            type: "line",
            data: {
                labels: [],
                datasets: [],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: "Date" } },
                    y: { title: { display: true, text: "Performance (%)" } },
                },
            },
        });

        // Create stock selection buttons
        sp500Stocks.forEach((ticker) => {
            const button = document.createElement("button");
            button.textContent = ticker;
            button.className = "stock-button";
            stockGrid.appendChild(button);

            button.addEventListener("click", () => {
                // Toggle selection
                if (selectedStocks.has(ticker)) {
                    selectedStocks.delete(ticker);
                    button.classList.remove("selected");
                } else if (selectedStocks.size < 10) {
                    selectedStocks.add(ticker);
                    button.classList.add("selected");
                } else {
                    alert("You can select up to 10 stocks.");
                }

                // Recalculate weights so they sum to 100%
                recalcEqualStockWeights();
                // Re-render the numeric inputs
                renderWeightInputs();
            });
        });

        /**
         *  Recalculate weights so that all selected stocks share 100% equally.
         *  e.g., if 3 stocks are selected, each becomes 100/3 = 33.33...
         */
        function recalcEqualStockWeights() {
            if (selectedStocks.size === 0) return;
            const equalWeight = 100 / selectedStocks.size;

            selectedStocks.forEach((ticker) => {
                stockWeights[ticker] = equalWeight;
            });
        }

        /**
         * Renders the weight inputs for the currently selected stocks
         * so the user can still override them if desired.
         */
        function renderWeightInputs() {
            portfolioWeightsDiv.innerHTML = "<h3>Adjust Portfolio Weights</h3>";

            selectedStocks.forEach((ticker) => {
                const label = document.createElement("label");
                label.className = "weight-label";
                const value = stockWeights[ticker] 
                    ? parseFloat(stockWeights[ticker]).toFixed(2) 
                    : "0";

                label.innerHTML = `
                    ${ticker}: 
                    <input 
                        type="number" 
                        class="weight-input" 
                        data-ticker="${ticker}" 
                        value="${value}" 
                        min="0" 
                        max="100" 
                        step="0.01"
                    /> %
                `;
                portfolioWeightsDiv.appendChild(label);
            });
        }

        // Create a new portfolio from the currently selected stocks and weights
        createPortfolioButton.addEventListener("click", () => {
            // Read the weights from the inputs
            const inputs = document.querySelectorAll(".weight-input");
            let totalWeight = 0;

            inputs.forEach((input) => {
                const ticker = input.dataset.ticker;
                const value = parseFloat(input.value) || 0;
                if (value >= 0) {
                    stockWeights[ticker] = value;
                    totalWeight += value;
                }
            });

            if (Math.round(totalWeight) !== 100) {
                // If you prefer to allow a slight float margin of error, you can do a check with a small epsilon
                weightValidationMessage.style.display = "block";
                return;
            }
            weightValidationMessage.style.display = "none";

            const portfolioName = prompt("Enter portfolio name:");
            if (!portfolioName) {
                return alert("Portfolio name is required.");
            }

            const portfolio = {
                name: portfolioName,
                stocks: Array.from(selectedStocks),
                weights: { ...stockWeights },
            };

            // Add to the saved list
            activePortfolios.push(portfolio);

            // Re-render
            renderSavedPortfolios();
            renderPortfolioOptions();
        });

        // Renders all saved portfolios
        function renderSavedPortfolios() {
            savedPortfoliosDiv.innerHTML = "<h2>Saved Portfolios</h2>";

            activePortfolios.forEach((portfolio, index) => {
                const portfolioDiv = document.createElement("div");
                portfolioDiv.className = "portfolio";
                portfolioDiv.dataset.index = index;

                // Construct the markup
                portfolioDiv.innerHTML = `
                    <h3>${portfolio.name}</h3>
                    <ul class="stock-weight-list">
                        ${portfolio.stocks
                            .map(
                                (stock) => 
                                    `<li>${stock}: ${portfolio.weights[stock].toFixed(2)}%</li>`
                            )
                            .join("")}
                    </ul>
                    <button class="edit-icon" data-index="${index}">‚úèÔ∏è Edit</button>
                    <button class="delete-icon" data-index="${index}">üóëÔ∏è Delete</button>
                `;

                // DELETE button
                portfolioDiv.querySelector(".delete-icon").addEventListener("click", () => {
                    activePortfolios.splice(index, 1);
                    renderSavedPortfolios();
                    renderPortfolioOptions();
                });

                // EDIT button (inline editing)
                portfolioDiv.querySelector(".edit-icon").addEventListener("click", () => {
                    enableInlineEdit(index);
                });

                savedPortfoliosDiv.appendChild(portfolioDiv);
            });
        }

        // Inline edit logic: switch the portfolio item into "editing" mode
        function enableInlineEdit(index) {
            const portfolio = activePortfolios[index];
            const portfolioDiv = savedPortfoliosDiv.querySelector(`.portfolio[data-index="${index}"]`);
            portfolioDiv.classList.add("editing");

            // Replace name with an input
            const nameHeading = portfolioDiv.querySelector("h3");
            const nameInput = document.createElement("input");
            nameInput.type = "text";
            nameInput.value = portfolio.name;
            nameInput.style.width = "80%";
            nameInput.addEventListener("input", (e) => {
                portfolio.name = e.target.value;
            });
            nameHeading.parentNode.replaceChild(nameInput, nameHeading);

            // Replace the stock list with inline inputs
            const ul = portfolioDiv.querySelector(".stock-weight-list");
            ul.innerHTML = "";
            portfolio.stocks.forEach((stock) => {
                const li = document.createElement("li");
                li.innerHTML = `
                    ${stock}: 
                    <input 
                        type="number" 
                        class="weight-input-inline" 
                        data-stock="${stock}" 
                        value="${portfolio.weights[stock].toFixed(2)}" 
                        min="0" 
                        max="100" 
                        step="0.01"
                    /> %
                `;
                ul.appendChild(li);
            });

            // Hide edit button, create save button
            const editButton = portfolioDiv.querySelector(".edit-icon");
            editButton.classList.add("hidden");
            const saveButton = document.createElement("button");
            saveButton.textContent = "üíæ Save";
            saveButton.className = "save-icon";
            saveButton.addEventListener("click", () => {
                saveInlineEdit(index);
            });
            portfolioDiv.insertBefore(saveButton, editButton.nextSibling);
        }

        // Saving after inline edit
        function saveInlineEdit(index) {
            const portfolio = activePortfolios[index];
            const portfolioDiv = savedPortfoliosDiv.querySelector(`.portfolio[data-index="${index}"]`);

            // Get updated name
            const nameInput = portfolioDiv.querySelector('input[type="text"]');
            portfolio.name = nameInput.value;

            // Get updated weights
            const weightInputs = portfolioDiv.querySelectorAll(".weight-input-inline");
            let totalWeight = 0;
            weightInputs.forEach((input) => {
                const stock = input.dataset.stock;
                const val = parseFloat(input.value) || 0;
                portfolio.weights[stock] = val;
                totalWeight += val;
            });

            // Check if weights sum to 100
            if (Math.round(totalWeight) !== 100) {
                alert("Weights must add up to 100%. Please adjust before saving.");
                return;
            }

            // Exit editing mode
            portfolioDiv.classList.remove("editing");
            const saveButton = portfolioDiv.querySelector(".save-icon");
            const editButton = portfolioDiv.querySelector(".edit-icon");
            editButton.classList.remove("hidden");
            if (saveButton) saveButton.remove();

            // Restore the h3
            const newH3 = document.createElement("h3");
            newH3.textContent = portfolio.name;
            nameInput.parentNode.replaceChild(newH3, nameInput);

            // Rebuild the UL
            const ul = portfolioDiv.querySelector(".stock-weight-list");
            ul.innerHTML = portfolio.stocks
                .map((stock) => `<li>${stock}: ${portfolio.weights[stock].toFixed(2)}%</li>`)
                .join("");

            // Rerender portfolio list and comparison buttons
            renderSavedPortfolios();
            renderPortfolioOptions();
        }

        // Render portfolio toggles for chart
        function renderPortfolioOptions() {
            portfolioOptionsDiv.innerHTML = "<h3>Select Portfolios to Compare:</h3>";

            activePortfolios.forEach((portfolio) => {
                const button = document.createElement("button");
                button.textContent = portfolio.name;
                button.className = "portfolio-option";
                portfolioOptionsDiv.appendChild(button);

                button.addEventListener("click", () => {
                    if (displayedPortfolios.includes(portfolio)) {
                        displayedPortfolios = displayedPortfolios.filter((p) => p !== portfolio);
                        button.classList.remove("selected");
                    } else {
                        displayedPortfolios.push(portfolio);
                        button.classList.add("selected");
                    }
                    updateGraphWithPortfolios();
                });
            });
        }

        // Mock fetch function to get stock data
        async function fetchStockData(ticker) {
            try {
                const response = await fetch(`https://my-vercel-api-lx6f.vercel.app/api/stocks/${ticker}`);
                if (!response.ok) throw new Error(`Error fetching stock data for ${ticker}`);
                return await response.json();
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        // Build the chart for all displayed portfolios
        async function updateGraphWithPortfolios() {
            performanceGraph.data.labels = [];
            performanceGraph.data.datasets = [];

            const periodValue = timePeriodSelector.value;
            const today = new Date();
            const periodStart = new Date(today);

            switch (periodValue) {
                case "1m":
                    periodStart.setMonth(today.getMonth() - 1);
                    break;
                case "3m":
                    periodStart.setMonth(today.getMonth() - 3);
                    break;
                case "6m":
                    periodStart.setMonth(today.getMonth() - 6);
                    break;
                case "1y":
                    periodStart.setFullYear(today.getFullYear() - 1);
                    break;
            }

            const dateLabels = new Set();

            for (const portfolio of displayedPortfolios) {
                const portfolioReturns = {};

                for (const ticker of portfolio.stocks) {
                    const data = await fetchStockData(ticker);
                    if (data && data.prices) {
                        data.prices.forEach((price) => {
                            const date = new Date(price.date).toLocaleDateString();
                            if (new Date(price.date) >= periodStart) {
                                dateLabels.add(date);
                                // Weighted sum
                                portfolioReturns[date] =
                                    (portfolioReturns[date] || 0) +
                                    (price.close * portfolio.weights[ticker]) / 100;
                            }
                        });
                    }
                }

                performanceGraph.data.datasets.push({
                    label: portfolio.name,
                    data: Array.from(dateLabels)
                        .sort((a, b) => new Date(a) - new Date(b))
                        .map((date) => portfolioReturns[date] || 0),
                    borderColor: `#${Math.floor(Math.random() * 16777215).toString(16)}`,
                    backgroundColor: "rgba(100, 255, 218, 0.2)",
                    fill: true,
                });
            }

            performanceGraph.data.labels = Array.from(dateLabels).sort((a, b) => new Date(a) - new Date(b));
            performanceGraph.update();
        }
    });
    </script>
</body>
</html>
